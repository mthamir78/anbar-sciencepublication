<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>College of Science — Faculty Publications Dashboard</title>

  <!-- ====== STYLES ====== -->
  <style>
    :root{
      --bg1:#fdf6e3; --bg2:#f7f3ec; --panel:#fcfaf7; --ink:#22201f;
      --muted:#465563; --line:#bfa054; --accent:#7b2632; --accent-2:#bfa054;
      --pill:#f2e9dc; --good:#2f7d32; --warn:#7b2632; --shadow:0 14px 36px rgba(123,38,50,.07);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--ink);
      font:15px/1.6 "Segoe UI","Roboto",Arial,sans-serif;
      background:linear-gradient(180deg,var(--bg1),var(--bg2)) fixed;
    }
    header{
      position:sticky; top:0; z-index:20;
      background:linear-gradient(180deg,#fcfaf7 97%,#f7f3ec 100%);
      border-bottom:2px solid var(--line);
      box-shadow:0 2px 8px rgba(191,160,84,.07);
    }
    .wrap{max-width:1350px;margin:0 auto;padding:14px 16px}
    h1{margin:0 0 6px; font-size:27px; letter-spacing:.4px; color:var(--accent); font-family:Georgia,Times,serif}
    h3,h4{font-family:Georgia,Times,serif; color:var(--accent)}
    .subtitle{color:var(--muted); font-size:14px}
    main{max-width:1350px;margin:18px auto; padding:0 16px 100px}
    .grid{display:grid; gap:16px}
    .card{background:var(--panel); border:1.5px solid var(--line); border-radius:16px; box-shadow:var(--shadow); color:var(--ink)}
    .pad{padding:14px}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .pill{padding:5px 10px; border-radius:999px; background:var(--pill); border:1px solid var(--line); color:var(--muted); font-size:12px; font-weight:600}

    /* Buttons */
    .btn{display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px;
         border:2px solid var(--accent); background:linear-gradient(180deg,#fcfaf7,#fdf6e3);
         color:var(--accent); font-weight:700; cursor:pointer; transition:.2s transform,.2s filter}
    .btn:hover{transform:translateY(-1px); filter:brightness(1.08); box-shadow:0 2px 8px #bfa054}
    .btn.primary{background:linear-gradient(180deg,var(--accent),#bfa054 95%); border-color:var(--accent); color:#fff}
    .btn.ghost{background:transparent; border-color:var(--line); color:var(--accent)}

    /* Tabs */
    .tabs{display:flex; gap:8px; padding:10px 14px; border-bottom:2px solid var(--line);
          position:sticky; top:56px; z-index:15;
          background:linear-gradient(90deg,#fcfaf7 80%,#f2e9dc 100%)}
    .tab{border:none; background:transparent; color:var(--muted); padding:8px 14px; border-radius:10px; cursor:pointer; font-weight:600; font-family:Georgia,Times,serif; transition:.15s background}
    .tab.active{background:linear-gradient(180deg,#f2e9dc 80%,#fcfaf7 100%); color:var(--accent); border:2px solid var(--accent); box-shadow:0 2px 8px var(--shadow)}
    .view{display:none}
    .view.active{display:block}

    /* Filters */
    .filters{display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:10px; padding:12px 14px}

    .filters input,.filters select{width:100%; padding:10px 12px; border-radius:10px; border:1.5px solid var(--line); background:#fcfaf7; color:var(--ink)}
    .filters .hint{font-size:12px; color:var(--muted)}

    /* Table */
    .scroll{overflow:auto}
    table{width:100%; border-collapse:separate; border-spacing:0 8px; background:var(--panel)}
    th,td{padding:10px 12px; text-align:left; white-space:nowrap}
    th{font-weight:700; color:var(--accent); border-bottom:2px solid var(--line); font-family:Georgia,Times,serif}
    tr{background:#f7f3ec; border:1.5px solid var(--line)}
    tr td:first-child, tr th:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
    tr td:last-child,  tr th:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
    th.small, td.small{font-size:12px; padding:6px 8px}

    /* Author list (kept) */
    .author-card{background:var(--panel); border:1.5px solid var(--line); border-radius:12px; padding:12px; margin-bottom:10px}
    .author-name{font-weight:700; letter-spacing:.2px; color:var(--accent); font-family:Georgia,Times,serif}
    .author-meta{color:var(--muted); font-size:13px}
    .badge{display:inline-block; padding:2px 6px; border-radius:6px; font-size:12px; background:var(--good); border:1px solid var(--line); color:#fff}
    .badge.good{background:var(--good); border-color:#8a8d6a}
    .badge.other{background:var(--warn); border-color:var(--warn)}

    dialog.details{max-width:980px; width:calc(100% - 24px); border:none; border-radius:16px; background:var(--panel); color:var(--ink)}
    dialog::backdrop{background:#7b263299; backdrop-filter:blur(2px)}
    .two{display:grid; grid-template-columns:1fr 1fr; gap:14px}
    @media (max-width:980px){.two{grid-template-columns:1fr}}
    .rtl{direction:rtl}
    footer{max-width:1350px;margin:18px auto;padding:0 16px}
  </style>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>

<body>
  <!-- ====== HEADER ====== -->
  <header>
    <div class="wrap row" style="justify-content:space-between">
      <div>
        <h1 id="title">Faculty Publications Dashboard</h1>
        <div class="subtitle" id="subtitle"></div>
      </div>
      <div class="row">
        <button class="btn ghost" id="toggleLang" aria-label="Toggle language">العربية</button>
        <span class="pill" id="lastUpdated">—</span>
      </div>
    </div>
  </header>

  <!-- ====== TABS ====== -->
  <nav class="tabs wrap" role="tablist">
    <button class="tab" data-tab="faculty" role="tab" aria-controls="view-faculty" aria-selected="true">Search</button>
    <button class="tab" data-tab="authors" role="tab" aria-controls="view-authors" aria-selected="false">Authors</button>
    <button class="tab" data-tab="analytics" role="tab" aria-controls="view-analytics" aria-selected="false">Analytics</button>
  </nav>

  <!-- ====== MAIN ====== -->
  <main class="wrap">
    <!-- SEARCH (Faculty table with per-year publisher columns) -->
    <section class="view card active" id="view-faculty">
      <div class="filters">
        <input type="text" id="qFaculty" placeholder="Search faculty (English/Arabic) …" autocomplete="off" />
        <select id="deptFilter"><option value="">All departments</option></select>
        <select id="degreeFilter"><option value="">All degrees</option></select>
        <select id="positionFilter"><option value="">All positions</option></select>
        <select id="yearSpan">
          <option value="5">Last 5 years</option>
          <option value="3">Last 3 years</option>
          <option value="10">Last 10 years</option>
          <option value="all">All years</option>
        </select>
        <button class="btn primary" id="exportCsv">Export summary CSV</button>
        <div class="hint">This table lists <b>all faculty</b> with counts per <b>year</b> and <b>publisher</b> (Scopus, Clarivate, Other).</div>
      </div>

      <div class="pad">
        <div class="row">
          <span class="pill">Faculty: <b id="statFaculty">0</b></span>
          <span class="pill">Indexed (Scopus+Clarivate): <b id="statIndexed">0</b></span>
          <span class="pill">Other: <b id="statOther">0</b></span>
          <span class="pill">Total: <b id="statTotal">0</b></span>
        </div>
      </div>

      <div class="pad scroll">
        <table id="tbl">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>

    <!-- AUTHORS (Cards retained) -->
    <section class="view card" id="view-authors">
      <div class="filters">
        <input type="text" id="qAuthor" placeholder="Search authors…" autocomplete="off"/>
        <select id="deptAuthorFilter"><option value="">All departments</option></select>
        <select id="yearFilter"><option value="">All years</option></select>
        <button class="btn primary" id="exportAuthors">Export authors CSV</button>
      </div>
      <div class="pad" id="authorsList"></div>
    </section>

    <!-- ANALYTICS -->
    <section class="view card" id="view-analytics">
      <div class="filters">
        <select id="yearForPct"><option value="">Select year for department %</option></select>
      </div>
      <div class="pad two">
        <div class="card pad">
          <h3 style="margin:0 0 6px">Department publisher mix (% of publications, selected year)</h3>
          <canvas id="deptPublisherPct" height="160" aria-label="Department publisher percentages"></canvas>
        </div>
        <div class="card pad">
          <h3 style="margin:0 0 6px">College publisher trend (counts by year)</h3>
          <canvas id="collegePublisherTrend" height="160" aria-label="Publisher trend"></canvas>
        </div>
      </div>
    </section>
  </main>

  <!-- ====== FOOTER ====== -->
  <footer>
    <div class="card pad">
      © <span id="yearNow"></span> • Designed by
      <span style="color:var(--accent-2); font-weight:600">Dr. Thamer Y. Mutter</span>
    </div>
  </footer>

  <!-- DETAILS DIALOG -->
  <dialog class="details" id="detailsDlg" aria-modal="true">
    <div class="pad">
      <div class="row" style="justify-content:space-between">
        <div>
          <h3 id="dName" style="margin:0 0 4px"></h3>
          <div id="dMeta" class="subtitle"></div>
        </div>
        <button class="btn" id="dClose" aria-label="Close details">Close</button>
      </div>
      <div style="height:10px"></div>
      <div class="two">
        <div class="card pad">
          <h4 style="margin:0 0 8px">Publications per year</h4>
          <canvas id="yearChart" height="130"></canvas>
        </div>
        <div class="card pad">
          <h4 style="margin:0 0 8px">Top journals (with metrics)</h4>
          <table style="width:100%">
            <thead><tr><th>Journal</th><th>Year</th><th>CiteScore</th><th>Impact Factor</th><th>Indexed</th><th>Other</th></tr></thead>
            <tbody id="dJournals"></tbody>
          </table>
        </div>
      </div>
    </div>
  </dialog>

  <!-- ====== SCRIPT ====== -->
  <script>
    /* ===== CONFIG ===== */
    const FEED_URL = 'https://script.google.com/macros/s/AKfycbyZ3riOiv1mIPpjNxsbcV34qvBCXevjAcLcckonpCxARI6KuEVUw8J9OkhJjbp5rruU/exec';

    /* ===== UTIL ===== */
    const $  = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const norm = s => (s||'').toString().toLowerCase().normalize('NFKD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,' ').trim();
    const unique = a => Array.from(new Set((a||[]).filter(Boolean)));
    const csvQ = v => `"${String(v ?? '').replace(/"/g,'""')}"`;
    const debounce = (fn, ms=240) => { let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; };
    const safeDestroy = c => { try{ c && c.destroy && c.destroy(); }catch(_){} };

    const state = { faculty:[], computed:[], charts:{}, filteredIdxs:[], allYears:[] };

    /* ===== ROUTER ===== */
    function setActiveTabFromHash(){
      const h = location.hash.replace(/^#/, '') || 'faculty';
      const [key,val] = h.split('=');
      const tabs = ['faculty','authors','analytics'];
      const target = tabs.includes(key) ? key : (key==='author' ? 'authors' : 'faculty');

      $$('.tab').forEach(t => {
        const active = t.dataset.tab === target;
        t.classList.toggle('active', active);
        t.setAttribute('aria-selected', String(active));
      });
      $$('.view').forEach(v => v.classList.toggle('active', v.id === 'view-'+target));

      if (key === 'author' && val){
        const idxByName = state.faculty.findIndex(f => norm(f?.english_names?.[0]) === norm(decodeURIComponent(val)));
        const idx = isNaN(+val) ? idxByName : +val;
        if (idx >= 0) openDetails(idx);
      }
      if (target === 'analytics') setTimeout(buildAnalytics, 60);
    }
    window.addEventListener('hashchange', setActiveTabFromHash);
    const goto = tab => location.hash = '#'+tab;

    /* ===== DATA ===== */
    async function loadFeed(){
      const url = FEED_URL + '?cb=' + Date.now();
      let res;
      try{ res = await fetch(url, {cache:'no-store'}); }
      catch(e){ console.error(e); alert('Network error reaching the feed.'); return; }
      if (!res.ok){ alert('Feed not reachable ('+res.status+').'); return; }
      const j = await res.json();
      state.faculty  = j.faculty  || [];
      state.computed = j.computed || [];
      $('#lastUpdated').textContent = j.generated_at ? ('Updated: ' + new Date(j.generated_at).toLocaleString()) : 'Updated: now';

      // build year universe
      const years1 = state.computed.flatMap(r => (r.byYear||[]).map(([y])=>y));
      // allow explicit publisher breakdown if present
      const years2 = state.computed.flatMap(r => (r.byYearPub||[]).map(([y])=>y));
      // journals fallback
      const years3 = state.computed.flatMap(r => (r.journals||[]).map(j=>j.year).filter(Boolean));
      state.allYears = unique([...years1, ...years2, ...years3]).sort();
    }

    /* ===== PUBLISHER BREAKDOWN HELPERS =====
       Returns Map(year => {scopus, clarivate, other})
       Priority:
       1) rec.byYearPub: [[year,{scopus,clarivate,other}], ...]
       2) rec.journals: infer via fields (citescore=>Scopus, impact_factor=>Clarivate)
       3) rec.byYear: split as scopus= indexed, clarivate=0, other=other
    */
    function yearPublisherMap(rec){
      const m = new Map();

      if (Array.isArray(rec.byYearPub) && rec.byYearPub.length){
        for (const [y,obj] of rec.byYearPub){
          const S = +obj.scopus    || 0;
          const C = +obj.clarivate || 0;
          const O = +obj.other     || 0;
          m.set(String(y), {scopus:S, clarivate:C, other:O});
        }
        return m;
      }

      if (Array.isArray(rec.journals) && rec.journals.length){
        for (const j of rec.journals){
          const y = String(j.year||'');
          if (!y) continue;
          const cur = m.get(y) || {scopus:0, clarivate:0, other:0};

          const idx = +j.indexed || 0;
          const oth = +j.other   || 0;

          // Heuristics:
          // - citescore present -> Scopus
          // - impact_factor present -> Clarivate
          // - both present -> split evenly (round to Scopus then Clarivate)
          // - neither -> treat as Scopus (most generous) unless a string flag exists
          const hasCS = j.citescore != null && j.citescore !== '';
          const hasIF = j.impact_factor != null && j.impact_factor !== '';
          const src   = (j.source||j.index_source||'').toString().toLowerCase();

          if (src.includes('scopus'))        { cur.scopus    += idx; }
          else if (src.includes('clarivate') || src.includes('wos') || src.includes('web of science')) { cur.clarivate += idx; }
          else if (hasCS && !hasIF)          { cur.scopus    += idx; }
          else if (!hasCS && hasIF)          { cur.clarivate += idx; }
          else if (hasCS && hasIF){
            const s = Math.round(idx/2);
            cur.scopus += s; cur.clarivate += (idx - s);
          }else{
            cur.scopus += idx; // fallback: treat indexed as Scopus
          }

          cur.other += oth;
          m.set(y, cur);
        }
        return m;
      }

      if (Array.isArray(rec.byYear) && rec.byYear.length){
        for (const [y,c] of rec.byYear){
          const S = +c.indexed || 0; // fallback -> Scopus bucket
          const O = +c.other   || 0;
          m.set(String(y), {scopus:S, clarivate:0, other:O});
        }
        return m;
      }

      return m;
    }

    /* ===== FILTERS (populate) ===== */
    function populateFilters(){
      const depts = unique(state.faculty.map(f=>f.department)).sort();
      const degs  = unique(state.faculty.map(f=>f.degree)).sort();
      const poss  = unique(state.faculty.map(f=>f.position)).sort();
      const years = state.allYears;

      const fill = (sel, arr, label) => {
        $(sel).innerHTML = `<option value="">${label}</option>` + arr.map(v=>`<option>${v}</option>`).join('');
      };
      fill('#deptFilter',depts,'All departments');
      fill('#degreeFilter',degs,'All degrees');
      fill('#positionFilter',poss,'All positions');

      fill('#deptAuthorFilter',depts,'All departments');
      fill('#yearFilter',years,'All years');

      // analytics year picker
      $('#yearForPct').innerHTML = `<option value="">Choose year…</option>` + years.map(y=>`<option>${y}</option>`).join('');
    }

    /* ===== SEARCH TABLE (Faculty with per-year publisher cols) ===== */
    function buildSearchHeader(years){
      const thead = $('#thead');
      // First row: static + year groups
      const staticCols = [
        '<th rowspan="2">#</th>',
        '<th rowspan="2">Faculty</th>',
        '<th rowspan="2">Arabic</th>',
        '<th rowspan="2">Dept</th>',
        '<th rowspan="2">Degree</th>',
        '<th rowspan="2">Position</th>',
        '<th rowspan="2">Scopus ID</th>',
        '<th rowspan="2">Clarivate ID</th>'
      ].join('');

      const groupCols = years.map(y=>`<th class="small" colspan="4">${y}</th>`).join('');
      const r1 = `<tr>${staticCols}${groupCols}</tr>`;

      // Second row: S C O T under each year
      const sub = years.map(()=>[
        '<th class="small">S</th>',
        '<th class="small">C</th>',
        '<th class="small">O</th>',
        '<th class="small">T</th>'
      ].join('')).join('');
      const r2 = `<tr>${sub}</tr>`;

      thead.innerHTML = r1 + r2;
    }

    function yearsToShow(){
      const ys = state.allYears;
      const span = $('#yearSpan').value || '5';
      if (span === 'all') return ys;
      const n = parseInt(span,10);
      return ys.slice(-n); // last N
    }

    function renderFacultyTable(){
      const q = norm($('#qFaculty').value);
      const dept = $('#deptFilter').value, deg = $('#degreeFilter').value, pos = $('#positionFilter').value;

      const years = yearsToShow();
      buildSearchHeader(years);

      const tb = $('#tbody'); tb.innerHTML=''; let i=0; state.filteredIdxs=[];

      for (const rec of state.computed){
        const f = rec.fac || state.faculty[rec.idx];
        if (!f) continue;

        if (q && ![...(f.english_names||[]), f.arabic_name||''].some(n=>norm(n).includes(q))) continue;
        if (dept && f.department !== dept) continue;
        if (deg  && f.degree    !== deg ) continue;
        if (pos  && f.position  !== pos ) continue;

        state.filteredIdxs.push(rec.idx);

        const yMap = yearPublisherMap(rec);
        const cells = years.map(y=>{
          const obj = yMap.get(String(y)) || {scopus:0,clarivate:0,other:0};
          const t = obj.scopus + obj.clarivate + obj.other;
          return `<td class="small">${obj.scopus||0}</td><td class="small">${obj.clarivate||0}</td><td class="small">${obj.other||0}</td><td class="small"><b>${t}</b></td>`;
        }).join('');

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${++i}</td>
          <td><b>${(f.english_names?.[0])||'—'}</b></td>
          <td>${f.arabic_name||''}</td>
          <td>${f.department||'—'}</td>
          <td>${f.degree||'—'}</td>
          <td>${f.position||'—'}</td>
          <td>${f.scopus_id||'—'}</td>
          <td>${f.clarivate_id||'—'}</td>
          ${cells}
        `;
        tb.appendChild(tr);
      }
      updateKPIs();
      buildFacultyCharts(); // keeps your existing dept/year visuals
    }

    function updateKPIs(){
      const idx = state.computed.reduce((s,r)=>s + ((r.counts?.indexed)||0), 0);
      const oth = state.computed.reduce((s,r)=>s + ((r.counts?.other)||0)  , 0);
      $('#statFaculty').textContent = state.faculty.length;
      $('#statIndexed').textContent = idx;
      $('#statOther').textContent   = oth;
      $('#statTotal').textContent   = idx + oth;
    }

    /* ===== EXISTING FACULTY CHARTS (kept) ===== */
    function buildFacultyCharts(){
      // Dept totals (indexed/other)
      const deptMap = new Map();
      for (const rec of state.computed){
        const f = rec.fac || state.faculty[rec.idx];
        const d = f?.department || '—';
        const cur = deptMap.get(d) || {i:0,o:0};
        cur.i += (rec.counts?.indexed)||0; cur.o += (rec.counts?.other)||0;
        deptMap.set(d, cur);
      }
      const labels = [...deptMap.keys()];
      const iData  = labels.map(l => deptMap.get(l).i);
      const oData  = labels.map(l => deptMap.get(l).o);

      safeDestroy(state.charts.dept);
      state.charts.dept = new Chart($('#deptBar'), {
        type:'bar',
        data:{ labels, datasets:[{label:'Indexed', data:iData}, {label:'Other', data:oData}] },
        options:{ responsive:true, maintainAspectRatio:false }
      });

      // Year aggregated (indexed/other)
      const yearAgg = new Map();
      for (const r of state.computed){
        for (const [y,c] of (r.byYear||[])){
          const o = yearAgg.get(y) || {i:0,o:0};
          o.i += (+c.indexed||0); o.o += (+c.other||0);
          yearAgg.set(y,o);
        }
      }
      const ys = [...yearAgg.keys()].sort();
      const yi = ys.map(y=>yearAgg.get(y).i);
      const yo = ys.map(y=>yearAgg.get(y).o);

      safeDestroy(state.charts.year);
      state.charts.year = new Chart($('#yearLine'), {
        type:'line',
        data:{ labels:ys, datasets:[{label:'Indexed', data:yi, tension:.3}, {label:'Other', data:yo, tension:.3}] },
        options:{ responsive:true, maintainAspectRatio:false }
      });
    }

    /* ===== ANALYTICS: Percentages by department per year (publisher mix) + college trend ===== */
    function buildAnalytics(){
      // build college publisher trend (counts per year, all depts)
      const college = new Map(); // year => {S,C,O}
      for (const rec of state.computed){
        const m = yearPublisherMap(rec);
        for (const [y,v] of m.entries()){
          const cur = college.get(y) || {S:0,C:0,O:0};
          cur.S += v.scopus; cur.C += v.clarivate; cur.O += v.other;
          college.set(y, cur);
        }
      }
      const years = [...college.keys()].sort();
      safeDestroy(state.charts.collegeTrend);
      state.charts.collegeTrend = new Chart($('#collegePublisherTrend'), {
        type:'line',
        data:{ labels:years, datasets:[
          {label:'Scopus',    data:years.map(y=>college.get(y).S), tension:.3},
          {label:'Clarivate', data:years.map(y=>college.get(y).C), tension:.3},
          {label:'Other',     data:years.map(y=>college.get(y).O), tension:.3},
        ]},
        options:{ responsive:true, maintainAspectRatio:false }
      });

      // department % for selected year
      renderDeptPctForYear($('#yearForPct').value);
    }

    function renderDeptPctForYear(year){
      const ySel = String(year||'');
      const deptMix = new Map(); // dept => {S,C,O,total}
      for (const rec of state.computed){
        const f = rec.fac || state.faculty[rec.idx]; if (!f) continue;
        const d = f.department || '—';
        const m = yearPublisherMap(rec);
        const v = m.get(ySel) || {scopus:0,clarivate:0,other:0};
        const cur = deptMix.get(d) || {S:0,C:0,O:0,T:0};
        cur.S += v.scopus; cur.C += v.clarivate; cur.O += v.other;
        cur.T += v.scopus + v.clarivate + v.other;
        deptMix.set(d, cur);
      }
      const depts = [...deptMix.keys()];
      const S = depts.map(d=>pct(deptMix.get(d).S, deptMix.get(d).T));
      const C = depts.map(d=>pct(deptMix.get(d).C, deptMix.get(d).T));
      const O = depts.map(d=>pct(deptMix.get(d).O, deptMix.get(d).T));

      safeDestroy(state.charts.deptPct);
      state.charts.deptPct = new Chart($('#deptPublisherPct'), {
        type:'bar',
        data:{ labels:depts, datasets:[
          {label:'Scopus %',    data:S, stack:'pct'},
          {label:'Clarivate %', data:C, stack:'pct'},
          {label:'Other %',     data:O, stack:'pct'},
        ]},
        options:{
          responsive:true, maintainAspectRatio:false,
          scales:{ y:{ min:0, max:100, ticks:{callback:v=>v+'%'} } },
          plugins:{ tooltip:{ callbacks:{ label:ctx => `${ctx.dataset.label}: ${ctx.formattedValue}%` } } }
        }
      });

      function pct(n,t){ return t? Math.round((n/t)*100) : 0; }
    }

    /* ===== AUTHORS VIEW (cards) ===== */
    function renderAuthors(){
      const q    = norm($('#qAuthor').value);
      const dept = $('#deptAuthorFilter').value;
      const year = $('#yearFilter').value;

      const host = $('#authorsList'); host.innerHTML = '';
      const records = state.computed
        .map(r => ({...r, fac: r.fac || state.faculty[r.idx]}))
        .filter(r => !!r.fac);

      for (const r of records){
        const f = r.fac;

        if (q && ![...(f.english_names||[]), f.arabic_name||''].some(n=>norm(n).includes(q))) continue;
        if (dept && f.department !== dept) continue;
        if (year){
          const m = yearPublisherMap(r);
          const v = m.get(String(year));
          const totalInYear = v ? (v.scopus+v.clarivate+v.other) : 0;
          if (!totalInYear) continue;
        }

        const m = yearPublisherMap(r);
        const mostRecent = state.allYears.slice(-1)[0];
        const v = m.get(String(mostRecent)) || {scopus:0,clarivate:0,other:0};
        const total = v.scopus + v.clarivate + v.other;

        const el = document.createElement('div');
        el.className = 'author-card';
        el.innerHTML = `
          <div class="row" style="justify-content:space-between">
            <div>
              <div class="author-name">${f.english_names?.[0] || '—'}</div>
              <div class="author-meta">${f.department||'—'} • ${f.degree||'—'} • ${f.position||'—'}</div>
            </div>
            <div class="row">
              <span class="badge" title="Scopus">${v.scopus||0}</span>
              <span class="badge" title="Clarivate">${v.clarivate||0}</span>
              <span class="badge other" title="Other">${v.other||0}</span>
              <span class="pill" title="Most recent year total">${mostRecent}: <b>${total}</b></span>
              <button class="btn" data-open="${r.idx}">Details</button>
            </div>
          </div>`;
        host.appendChild(el);
      }

      host.querySelectorAll('button[data-open]').forEach(b => b.addEventListener('click', () => openDetails(+b.dataset.open)));
    }

    /* ===== DETAILS DIALOG ===== */
    function openDetails(idx){
      const rec = state.computed.find(r=>r.idx===idx);
      const f = rec?.fac || state.faculty[idx];
      if (!rec || !f) return;

      $('#dName').textContent = (f.english_names?.[0]) || '—';
      $('#dMeta').textContent = `${f.department||'—'} • ${f.degree||'—'} • ${f.position||'—'}`;

      // year chart (publisher split)
      const m = yearPublisherMap(rec);
      const ys = state.allYears;
      const S = ys.map(y=> (m.get(String(y))||{scopus:0}).scopus );
      const C = ys.map(y=> (m.get(String(y))||{clarivate:0}).clarivate );
      const O = ys.map(y=> (m.get(String(y))||{other:0}).other );

      safeDestroy(state.charts.detailYear);
      state.charts.detailYear = new Chart($('#yearChart'), {
        type:'line',
        data:{ labels:ys, datasets:[
          {label:'Scopus',    data:S, tension:.3},
          {label:'Clarivate', data:C, tension:.3},
          {label:'Other',     data:O, tension:.3}
        ]},
        options:{ responsive:true, maintainAspectRatio:false }
      });

      // journals table (as-is)
      const tb = $('#dJournals'); tb.innerHTML = '';
      (rec.journals||[]).slice(0,30).forEach(j=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${j.journal||'—'}</td><td>${j.year||''}</td><td>${j.citescore||''}</td><td>${j.impact_factor||''}</td><td>${j.indexed||0}</td><td>${j.other||0}</td>`;
        tb.appendChild(tr);
      });

      $('#detailsDlg').showModal();
      location.hash = '#author=' + encodeURIComponent(f.english_names?.[0] || idx);
    }
    $('#dClose').addEventListener('click', () => { $('#detailsDlg').close(); history.replaceState(null,'', '#faculty'); });

    /* ===== EXPORTS ===== */
    function exportFacultyCsv(){
      // Export wide table for current year-span (per year per publisher)
      const years = yearsToShow();
      const headers = [
        'Name','Arabic','Department','Degree','Position','ScopusID','ClarivateID',
        ...years.flatMap(y=>[`${y} Scopus`,`${y} Clarivate`,`${y} Other`,`${y} Total`])
      ];
      let out = headers.join(',') + '\n';

      for (const rec of state.computed){
        const f = rec.fac || state.faculty[rec.idx];
        if (!f) continue;
        const yMap = yearPublisherMap(rec);
        const row = [
          f.english_names?.[0]||'',
          f.arabic_name||'',
          f.department||'',
          f.degree||'',
          f.position||'',
          f.scopus_id||'',
          f.clarivate_id||'',
          ...years.flatMap(y=>{
            const v = yMap.get(String(y)) || {scopus:0,clarivate:0,other:0};
            return [v.scopus, v.clarivate, v.other, v.scopus+v.clarivate+v.other];
          })
        ].map(csvQ).join(',');
        out += row + '\n';
      }
      const url = URL.createObjectURL(new Blob([out], {type:'text/csv'}));
      const a = Object.assign(document.createElement('a'), {href:url, download:'faculty_by_year_publisher.csv'});
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }
    const exportAuthorsCsv = exportFacultyCsv;

    /* ===== I18N ===== */
    let CUR_LANG = localStorage.getItem('lang') || 'en';
    const I18N = {
      en:{title:'Faculty Publications Dashboard', sub:'', tabs:['Search','Authors','Analytics'], langBtn:'العربية'},
      ar:{title:'لوحة منشورات التدريسيين', sub:'', tabs:['بحث','المؤلفون','التحليلات'], langBtn:'English'}
    };
    function applyLang(){
      const t = I18N[CUR_LANG] || I18N.en;
      document.documentElement.lang = CUR_LANG === 'ar' ? 'ar' : 'en';
      $('#title').textContent = t.title;
      $('#subtitle').textContent = t.sub;
      $('#toggleLang').textContent = t.langBtn;
      document.body.classList.toggle('rtl', CUR_LANG==='ar');
      $$('.tab').forEach((el,i)=> el.textContent = t.tabs[i]);
      localStorage.setItem('lang', CUR_LANG);
    }
    $('#toggleLang').addEventListener('click', () => { CUR_LANG = (CUR_LANG==='en' ? 'ar' : 'en'); applyLang(); });

    /* ===== INIT ===== */
    (async function init(){
      $('#yearNow').textContent = new Date().getFullYear();

      try { await loadFeed(); }
      catch(e){ console.error(e); alert('Could not load feed. Check FEED_URL.'); }

      populateFilters();
      renderFacultyTable();        // search tab
      renderAuthors();             // authors tab
      applyLang();

      // events
      $('#qFaculty').addEventListener('input', debounce(renderFacultyTable, 240));
      $('#deptFilter').addEventListener('change', renderFacultyTable);
      $('#degreeFilter').addEventListener('change', renderFacultyTable);
      $('#positionFilter').addEventListener('change', renderFacultyTable);
      $('#yearSpan').addEventListener('change', renderFacultyTable);
      $('#exportCsv').addEventListener('click', exportFacultyCsv);
      $('#exportAuthors').addEventListener('click', exportAuthorsCsv);

      // authors view events
      $('#qAuthor').addEventListener('input', debounce(renderAuthors, 240));
      $('#deptAuthorFilter').addEventListener('change', renderAuthors);
      $('#yearFilter').addEventListener('change', renderAuthors);

      // analytics
      $('#yearForPct').addEventListener('change', (e)=> renderDeptPctForYear(e.target.value));
      buildAnalytics();

      // tabs/hashes
      $$('.tab').forEach(b => b.addEventListener('click', () => goto(b.dataset.tab)));
      setActiveTabFromHash();
    })();
  </script>
</body>
</html>
